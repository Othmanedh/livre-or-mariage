<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Livre d'Or</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .login-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .login-container button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .error {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .admin-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .admin-header h1 {
            color: #333;
            font-size: 32px;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-download {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-download:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-logout {
            background: #ff4444;
            color: white;
        }

        .btn-logout:hover {
            background: #cc0000;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 16px;
        }

        .messages-container {
            display: grid;
            gap: 20px;
        }

        .message-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .message-header h3 {
            color: #333;
            font-size: 20px;
        }

        .message-date {
            color: #999;
            font-size: 14px;
        }

        .message-text {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .message-media {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .media-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .media-item audio {
            width: 100%;
            padding: 10px;
        }

        .media-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-progress {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .download-progress.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                text-align: center;
            }

            .admin-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Formulaire de connexion -->
    <div class="login-container" id="loginContainer">
        <h2>üîê Administration</h2>
        <input type="password" id="passwordInput" placeholder="Mot de passe" />
        <button onclick="login()">Se connecter</button>
        <p class="error" id="loginError">Mot de passe incorrect</p>
    </div>

    <!-- Interface admin -->
    <div class="admin-container" id="adminContainer">
        <div class="admin-header">
            <h1>üìñ Livre d'Or - Administration</h1>
            <div class="admin-actions">
                <button class="btn btn-download" id="downloadBtn" onclick="downloadAll()">
                    üíæ T√©l√©charger tout
                </button>
                <button class="btn btn-logout" onclick="logout()">
                    üö™ D√©connexion
                </button>
            </div>
        </div>

        <div class="download-progress" id="downloadProgress">
            <p id="downloadText">Pr√©paration du t√©l√©chargement...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalMessages">0</h3>
                <p>Messages</p>
            </div>
            <div class="stat-card">
                <h3 id="totalPhotos">0</h3>
                <p>Photos</p>
            </div>
            <div class="stat-card">
                <h3 id="totalVideos">0</h3>
                <p>Vid√©os</p>
            </div>
            <div class="stat-card">
                <h3 id="totalAudios">0</h3>
                <p>Audios</p>
            </div>
        </div>

        <div class="loading" id="loadingMessages">
            <div class="spinner"></div>
            <p>Chargement des messages...</p>
        </div>

        <div class="messages-container" id="messagesContainer"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- JSZip pour cr√©er le ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDN9QwYAhUknAGLvi1RoRVYeBoZgimdiBQ",
            authDomain: "livre-or-mariage-5ab84.firebaseapp.com",
            projectId: "livre-or-mariage-5ab84",
            storageBucket: "livre-or-mariage-5ab84.firebasestorage.app",
            messagingSenderId: "929509681224",
            appId: "1:929509681224:web:b6c85d91b8b6a59956970d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const ADMIN_PASSWORD = 'SaraOthmane0612';
        let allMessages = [];

        function login() {
            const password = document.getElementById('passwordInput').value;
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'block';
                sessionStorage.setItem('adminLoggedIn', 'true');
                loadMessages();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        // V√©rifier si d√©j√† connect√©
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            loadMessages();
        }

        async function loadMessages() {
            try {
                const snapshot = await db.collection('messages').orderBy('timestamp', 'desc').get();
                allMessages = [];

                let totalPhotos = 0;
                let totalVideos = 0;
                let totalAudios = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allMessages.push({ id: doc.id, ...data });

                    if (data.media) {
                        data.media.forEach(m => {
                            if (m.type === 'photo') totalPhotos++;
                            if (m.type === 'video') totalVideos++;
                            if (m.type === 'audio') totalAudios++;
                        });
                    }
                });

                // Mettre √† jour les statistiques
                document.getElementById('totalMessages').textContent = allMessages.length;
                document.getElementById('totalPhotos').textContent = totalPhotos;
                document.getElementById('totalVideos').textContent = totalVideos;
                document.getElementById('totalAudios').textContent = totalAudios;

                // Afficher les messages
                displayMessages();

                document.getElementById('loadingMessages').style.display = 'none';
            } catch (error) {
                console.error('Erreur chargement:', error);
                alert('Erreur lors du chargement des messages');
            }
        }

        function displayMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            allMessages.forEach(msg => {
                const card = document.createElement('div');
                card.className = 'message-card';

                const date = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString('fr-FR') : 'Date inconnue';

                card.innerHTML = `
                    <div class="message-header">
                        <h3>üë§ ${msg.guestName}</h3>
                        <span class="message-date">${date}</span>
                    </div>
                    ${msg.message ? `<p class="message-text">${msg.message}</p>` : ''}
                    <div class="message-media" id="media-${msg.id}"></div>
                `;

                container.appendChild(card);

                // Afficher les m√©dias
                if (msg.media && msg.media.length > 0) {
                    const mediaContainer = document.getElementById(`media-${msg.id}`);
                    
                    msg.media.forEach(media => {
                        const mediaDiv = document.createElement('div');
                        mediaDiv.className = 'media-item';

                        if (media.type === 'photo') {
                            mediaDiv.innerHTML = `
                                <img src="${media.url}" alt="Photo">
                                <span class="media-label">üì∑ Photo</span>
                            `;
                        } else if (media.type === 'video') {
                            mediaDiv.innerHTML = `
                                <video src="${media.url}" controls></video>
                                <span class="media-label">üé• Vid√©o</span>
                            `;
                        } else if (media.type === 'audio') {
                            mediaDiv.innerHTML = `
                                <audio src="${media.url}" controls></audio>
                                <span class="media-label">üé§ Audio</span>
                            `;
                        }

                        mediaContainer.appendChild(mediaDiv);
                    });
                }
            });
        }

        async function downloadAll() {
            if (allMessages.length === 0) {
                alert('Aucun message √† t√©l√©charger');
                return;
            }

            const downloadBtn = document.getElementById('downloadBtn');
            const progressDiv = document.getElementById('downloadProgress');
            const progressText = document.getElementById('downloadText');
            const progressFill = document.getElementById('progressFill');

            downloadBtn.disabled = true;
            progressDiv.classList.add('show');

            try {
                const zip = new JSZip();
                const messagesFolder = zip.folder('messages');

                // Cr√©er un fichier texte avec tous les messages
                let messagesText = 'LIVRE D\'OR - MARIAGE SARA & OTHMANE\n\n';
                messagesText += '='.repeat(50) + '\n\n';

                // T√©l√©charger tous les m√©dias
                let totalMedia = 0;
                allMessages.forEach(msg => {
                    if (msg.media) totalMedia += msg.media.length;
                });

                let mediaDownloaded = 0;
                let mediaIndex = 1;

                for (const msg of allMessages) {
                    const date = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString('fr-FR') : 'Date inconnue';
                    
                    messagesText += `üìÖ ${date}\n`;
                    messagesText += `üë§ ${msg.guestName}\n`;
                    if (msg.message) {
                        messagesText += `üí¨ ${msg.message}\n`;
                    }
                    messagesText += '\n' + '-'.repeat(50) + '\n\n';

                    // T√©l√©charger les m√©dias
                    if (msg.media && msg.media.length > 0) {
                        for (const media of msg.media) {
                            try {
                                progressText.textContent = `T√©l√©chargement ${mediaDownloaded + 1}/${totalMedia} m√©dias...`;
                                
                                const response = await fetch(media.url);
                                const blob = await response.blob();
                                
                                const extension = media.type === 'photo' ? 'jpg' : 
                                                media.type === 'video' ? 'mp4' : 'mp3';
                                
                                const filename = `${msg.guestName.replace(/[^a-z0-9]/gi, '_')}_${mediaIndex}_${media.type}.${extension}`;
                                messagesFolder.file(filename, blob);
                                
                                mediaDownloaded++;
                                mediaIndex++;
                                
                                const progress = Math.round((mediaDownloaded / totalMedia) * 100);
                                progressFill.style.width = progress + '%';
                                progressFill.textContent = progress + '%';
                            } catch (error) {
                                console.error('Erreur t√©l√©chargement m√©dia:', error);
                            }
                        }
                    }
                }

                // Ajouter le fichier texte
                zip.file('messages.txt', messagesText);

                // G√©n√©rer et t√©l√©charger le ZIP
                progressText.textContent = 'Cr√©ation du fichier ZIP...';
                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, 'Livre-Or-Sara-Othmane.zip');

                progressText.textContent = 'T√©l√©chargement termin√© !';
                
                setTimeout(() => {
                    progressDiv.classList.remove('show');
                    downloadBtn.disabled = false;
                    progressFill.style.width = '0%';
                    progressFill.textContent = '0%';
                }, 2000);

            } catch (error) {
                console.error('Erreur g√©n√©ration ZIP:', error);
                alert('Erreur lors de la cr√©ation du fichier ZIP');
                downloadBtn.disabled = false;
                progressDiv.classList.remove('show');
            }
        }

        // Permettre la connexion avec Entr√©e
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>