<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livre d'Or - Sara & Othmane</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', sans-serif; background: linear-gradient(135deg, #FFFFFF 0%, #F5F0E8 40%, #EFE8DC 70%, #E8DCC8 100%); min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1rem; }
        .gold-text { background: linear-gradient(135deg, #D4AF37 0%, #F4E5C3 50%, #D4AF37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .card { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 40px rgba(212, 175, 55, 0.15); margin-bottom: 2rem; }
        .btn { padding: 1rem 2rem; border-radius: 0.75rem; border: none; font-size: 1.125rem; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(135deg, #D4AF37, #F4E5C3, #D4AF37); color: white; }
        .btn-secondary { background: #E8DCC8; color: #8B7355; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; }
        .input { width: 100%; padding: 1rem; border: 2px solid #F4E5C3; border-radius: 0.75rem; font-size: 1rem; font-family: inherit; }
        .input:focus { outline: none; border-color: #D4AF37; }
        textarea { resize: vertical; min-height: 150px; }
        .hidden { display: none !important; }
        .loader { border: 4px solid #F4E5C3; border-top: 4px solid #D4AF37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .message-card { border-left: 5px solid #D4AF37; margin-bottom: 1rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; background: #F4E5C3; color: #8B7355; border-radius: 999px; font-size: 0.875rem; margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div style="text-align: center; margin-bottom: 3rem;">
            <p style="color: #8B7355; font-size: 1.125rem; margin-bottom: 1rem;">Bienvenue au mariage de</p>
            <h1 class="gold-text" style="font-family: 'Playfair Display', serif; font-size: 4rem; font-weight: 700; margin-bottom: 1rem;">Sara & Othmane</h1>
            <p style="color: #A89379; font-size: 1.5rem; font-family: 'Playfair Display', serif;">06 D√©cembre 2025</p>
        </div>

        <!-- Message de bienvenue -->
        <div class="card" style="text-align: center;">
            <p style="color: #8B7355; font-size: 1.25rem; margin-bottom: 1rem; font-family: 'Playfair Display', serif;">üéâ Bienvenue sur notre Livre d'Or en ligne !</p>
            <p style="color: #6B5744; font-size: 1.125rem; margin-bottom: 1rem; line-height: 1.7;">Laissez-nous un message : üíå √âcrit, üé§ Audio, üì∏ Photo ou üé• Vid√©o</p>
            <p style="color: #A89379; font-size: 1.125rem; font-style: italic; font-family: 'Playfair Display', serif;">Merci de tout c≈ìur pour votre pr√©sence ‚ú®</p>
        </div>

        <!-- Notification succ√®s -->
        <div id="successNotif" class="card hidden" style="position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); z-index: 1001; min-width: 300px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
            <h3 class="gold-text" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; font-family: 'Playfair Display', serif;">Merci beaucoup !</h3>
            <p style="color: #8B7355;">Votre message a √©t√© enregistr√©</p>
        </div>

        <!-- Overlay chargement -->
        <div id="loadingOverlay" class="overlay hidden">
            <div class="card" style="text-align: center; padding: 2rem;">
                <div class="loader" style="margin-bottom: 1rem;"></div>
                <p style="color: #8B7355; font-size: 1.25rem;" id="loadingText">Envoi en cours...</p>
            </div>
        </div>

        <!-- Boutons de choix -->
        <div id="choiceButtons" class="grid">
            <div class="card" style="text-align: center; cursor: pointer; border: 2px solid #F4E5C3;" onclick="showForm('text')">
                <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">‚úçÔ∏è</div>
                <div style="color: #8B7355; font-size: 1.25rem; font-weight: 600;">Message</div>
                <div style="color: #A89379;">√âcrit</div>
            </div>
            <div class="card" style="text-align: center; cursor: pointer; border: 2px solid #F4E5C3;" onclick="showForm('audio')">
                <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üé§</div>
                <div style="color: #8B7355; font-size: 1.25rem; font-weight: 600;">Message</div>
                <div style="color: #A89379;">Vocal</div>
            </div>
            <div class="card" style="text-align: center; cursor: pointer; border: 2px solid #F4E5C3;" onclick="showForm('photo')">
                <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üì∏</div>
                <div style="color: #8B7355; font-size: 1.25rem; font-weight: 600;">Photo</div>
                <div style="color: #A89379;">Selfie</div>
            </div>
            <div class="card" style="text-align: center; cursor: pointer; border: 2px solid #F4E5C3;" onclick="showForm('video')">
                <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üé•</div>
                <div style="color: #8B7355; font-size: 1.25rem; font-weight: 600;">Vid√©o</div>
                <div style="color: #A89379;">1 min max</div>
            </div>
        </div>

        <!-- Formulaire -->
        <div id="formContainer" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 id="formTitle" style="color: #8B7355; font-size: 1.5rem; font-family: 'Playfair Display', serif;"></h3>
                <button onclick="hideForm()" style="background: none; border: none; font-size: 1.5rem; color: #A89379; cursor: pointer;">‚úï</button>
            </div>
            <input type="text" id="guestName" class="input" placeholder="Votre pr√©nom" style="margin-bottom: 1.25rem;">
            <div id="formContent"></div>
        </div>

        <!-- Admin Login -->
        <div id="adminLogin" class="card hidden" style="max-width: 400px; margin: 5rem auto;">
            <h2 class="gold-text" style="text-align: center; font-size: 2rem; margin-bottom: 1.5rem; font-family: 'Playfair Display', serif;">Espace Admin</h2>
            <input type="password" id="adminPassword" class="input" placeholder="Mot de passe" style="margin-bottom: 1rem;">
            <p id="adminError" style="color: red; font-size: 0.875rem; margin-bottom: 1rem; text-align: center;" class="hidden"></p>
            <button onclick="adminLogin()" class="btn btn-primary" style="width: 100%;">Se connecter</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <h1 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem; font-family: 'Playfair Display', serif;">Admin - Sara & Othmane</h1>
            
            <!-- Debug Info -->
            <div id="debugInfo" class="card" style="background: #fff3cd; border: 2px solid #ffc107; margin-bottom: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">üîç Debug Info</div>
                <div id="debugText" style="font-size: 0.875rem; font-family: monospace;"></div>
            </div>
            
            <div class="card" style="text-align: center; margin-bottom: 2rem;">
                <div class="gold-text" style="font-size: 3rem; font-weight: 700;" id="adminCount">0</div>
                <div style="color: #8B7355; font-size: 1.125rem;">Messages re√ßus</div>
            </div>
            <button onclick="downloadMessages()" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">üì• T√©l√©charger tous les messages</button>
            <button onclick="loadAdminMessages()" class="btn btn-secondary" style="width: 100%; margin-bottom: 2rem;">üîÑ Actualiser</button>
            <div id="adminMessages"></div>
        </div>
    </div>

    <script>
        const CLOUDINARY_CLOUD_NAME = 'dukizthqt';
        const CLOUDINARY_UPLOAD_PRESET = 'wedding_guestbook';
        const ADMIN_PASSWORD = 'Sara18121703';
        const STORAGE_KEY = 'wedding-messages-v3';
        
        let currentType = '';
        let mediaRecorder = null;
        let recordedChunks = [];
        let stream = null;
        let recordingInterval = null;
        let recordingTime = 0;

        // V√©rifier si admin
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') {
            document.getElementById('choiceButtons').classList.add('hidden');
            document.querySelector('.card').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
        }

        function showForm(type) {
            currentType = type;
            document.getElementById('choiceButtons').classList.add('hidden');
            document.getElementById('formContainer').classList.remove('hidden');
            
            const titles = {
                text: '‚úçÔ∏è Votre message',
                audio: 'üé§ Message vocal',
                photo: 'üì∏ Prendre une photo',
                video: 'üé• Enregistrer une vid√©o'
            };
            document.getElementById('formTitle').textContent = titles[type];
            
            const formContent = document.getElementById('formContent');
            if (type === 'text') {
                formContent.innerHTML = `
                    <textarea id="messageText" class="input" placeholder="√âcrivez votre message aux mari√©s... üíï" style="margin-bottom: 1.25rem;"></textarea>
                    <button onclick="submitMessage()" class="btn btn-primary" style="width: 100%;">Envoyer</button>
                `;
            } else {
                formContent.innerHTML = `
                    <div id="mediaContent" style="text-align: center;"></div>
                `;
                if (type === 'photo') {
                    showCameraButton();
                } else {
                    showRecordButton();
                }
            }
        }

        function hideForm() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (recordingInterval) clearInterval(recordingInterval);
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('choiceButtons').classList.remove('hidden');
            recordedChunks = [];
            recordingTime = 0;
        }

        function showCameraButton() {
            document.getElementById('mediaContent').innerHTML = `
                <button onclick="startCamera()" class="btn btn-primary">Ouvrir la cam√©ra</button>
            `;
        }

        function showRecordButton() {
            document.getElementById('mediaContent').innerHTML = `
                <button onclick="startRecording()" class="btn btn-primary">Commencer l'enregistrement</button>
            `;
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('mediaContent').innerHTML = `
                    <video id="videoPreview" autoplay muted playsinline style="width: 100%; border-radius: 0.75rem; margin-bottom: 1rem;"></video>
                    <button onclick="capturePhoto()" class="btn btn-primary">üì∏ Prendre la photo</button>
                `;
                document.getElementById('videoPreview').srcObject = stream;
            } catch (error) {
                alert('Erreur cam√©ra: ' + error.message);
            }
        }

        function capturePhoto() {
            const video = document.getElementById('videoPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                stream.getTracks().forEach(track => track.stop());
                showPreview(URL.createObjectURL(blob), blob);
            }, 'image/jpeg', 0.9);
        }

        async function startRecording() {
            try {
                const constraints = {
                    audio: true,
                    video: currentType === 'video' ? { facingMode: 'user' } : false
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                let html = '';
                if (currentType === 'video') {
                    html = '<video id="videoPreview" autoplay muted playsinline style="width: 100%; border-radius: 0.75rem; margin-bottom: 1rem;"></video>';
                } else {
                    html = '<div style="font-size: 4rem; margin-bottom: 1rem;">üéôÔ∏è</div>';
                }
                
                html += `
                    <div id="timer" style="font-size: 2rem; font-weight: 700; color: #D4AF37; margin-bottom: 1rem;">0:00 / 1:00</div>
                    <button onclick="stopRecording()" class="btn" style="background: #ef4444; color: white;">‚èπÔ∏è Arr√™ter</button>
                `;
                
                document.getElementById('mediaContent').innerHTML = html;
                
                if (currentType === 'video') {
                    const videoEl = document.getElementById('videoPreview');
                    videoEl.srcObject = stream;
                    await videoEl.play();
                }
                
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { 
                        type: currentType === 'video' ? 'video/webm' : 'audio/webm' 
                    });
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    showPreview(URL.createObjectURL(blob), blob);
                };
                
                mediaRecorder.start();
                recordingTime = 0;
                
                recordingInterval = setInterval(() => {
                    recordingTime++;
                    const mins = Math.floor(recordingTime / 60);
                    const secs = recordingTime % 60;
                    const timerEl = document.getElementById('timer');
                    if (timerEl) {
                        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')} / 1:00`;
                    }
                    
                    if (recordingTime >= 60) {
                        stopRecording();
                    }
                }, 1000);
            } catch (error) {
                alert('Erreur cam√©ra/micro: ' + error.message + '\n\nV√©rifiez les permissions dans votre navigateur.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (recordingInterval) {
                clearInterval(recordingInterval);
                recordingInterval = null;
            }
        }

        function showPreview(url, blob) {
            let html = '';
            if (currentType === 'audio') {
                html = `<audio src="${url}" controls style="width: 100%; margin-bottom: 1rem;"></audio>`;
            } else if (currentType === 'photo') {
                html = `<img src="${url}" style="width: 100%; border-radius: 0.75rem; margin-bottom: 1rem;">`;
            } else if (currentType === 'video') {
                html = `<video src="${url}" controls style="width: 100%; border-radius: 0.75rem; margin-bottom: 1rem;"></video>`;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button onclick="showForm('${currentType}')" class="btn btn-secondary">Reprendre</button>
                    <button onclick="submitMessage('${url}', ${blob ? 'true' : 'false'})" class="btn btn-primary">Envoyer</button>
                </div>
            `;
            
            document.getElementById('mediaContent').innerHTML = html;
            
            // Stocker le blob temporairement
            window.currentBlob = blob;
        }

        async function submitMessage(mediaUrl, hasBlob) {
            const name = document.getElementById('guestName').value.trim();
            if (!name) {
                alert('Veuillez entrer votre nom');
                return;
            }
            
            let content = '';
            
            if (currentType === 'text') {
                content = document.getElementById('messageText').value.trim();
                if (!content) {
                    alert('Veuillez √©crire un message');
                    return;
                }
            } else {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                document.getElementById('loadingText').textContent = 'Upload en cours...';
                
                try {
                    const blob = window.currentBlob;
                    const formData = new FormData();
                    formData.append('file', blob);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    
                    const resourceType = (currentType === 'video' || currentType === 'audio') ? 'video' : 'image';
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`,
                        { method: 'POST', body: formData }
                    );
                    
                    if (!response.ok) throw new Error('Upload failed');
                    const data = await response.json();
                    content = data.secure_url;
                } catch (error) {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    alert('Erreur upload: ' + error.message);
                    return;
                }
            }
            
            const message = {
                id: Date.now(),
                type: currentType,
                name,
                content,
                timestamp: new Date().toISOString()
            };
            
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            messages.push(message);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
            
            document.getElementById('loadingOverlay').classList.add('hidden');
            hideForm();
            
            document.getElementById('successNotif').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('successNotif').classList.add('hidden');
            }, 3000);
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminMessages();
            } else {
                document.getElementById('adminError').textContent = 'Mot de passe incorrect';
                document.getElementById('adminError').classList.remove('hidden');
            }
        }

        function loadAdminMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            // Afficher les infos de debug
            const debugText = document.getElementById('debugText');
            debugText.innerHTML = `
                Cl√© de stockage: ${STORAGE_KEY}<br>
                Nombre de messages: ${messages.length}<br>
                localStorage disponible: ${localStorage ? 'OUI' : 'NON'}<br>
                Donn√©es brutes: ${localStorage.getItem(STORAGE_KEY) ? 'PR√âSENTES' : 'VIDES'}
            `;
            
            document.getElementById('adminCount').textContent = messages.length;
            
            const container = document.getElementById('adminMessages');
            if (messages.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; padding: 3rem;"><p style="color: #8B7355; font-size: 1.125rem;">Aucun message pour le moment</p><p style="color: #A89379; margin-top: 1rem;">Les messages appara√Ætront ici une fois envoy√©s par les invit√©s</p><p style="color: #ef4444; margin-top: 1rem; font-size: 0.875rem;">Si vous venez d\'envoyer un message, actualisez cette page</p></div>';
                return;
            }
            
            const sortedMessages = [...messages].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedMessages.map(msg => `
                <div class="card message-card">
                    <div style="font-weight: 600; font-size: 1.125rem; color: #8B7355; margin-bottom: 0.5rem;">${msg.name}</div>
                    <div style="font-size: 0.875rem; color: #A89379; margin-bottom: 0.75rem;">${new Date(msg.timestamp).toLocaleString('fr-FR')}</div>
                    <div class="badge">
                        ${msg.type === 'text' ? 'üìù Texte' : ''}
                        ${msg.type === 'audio' ? 'üé§ Audio' : ''}
                        ${msg.type === 'photo' ? 'üì∏ Photo' : ''}
                        ${msg.type === 'video' ? 'üé• Vid√©o' : ''}
                    </div>
                    ${msg.type === 'text' ? `<p style="color: #6B5744; font-size: 1.125rem; line-height: 1.7; white-space: pre-wrap;">${msg.content}</p>` : ''}
                    ${msg.type === 'audio' ? `<audio src="${msg.content}" controls style="width: 100%; margin-top: 0.5rem;"></audio>` : ''}
                    ${msg.type === 'photo' ? `<img src="${msg.content}" style="width: 100%; border-radius: 0.75rem; margin-top: 0.5rem;">` : ''}
                    ${msg.type === 'video' ? `<video src="${msg.content}" controls style="width: 100%; border-radius: 0.75rem; margin-top: 0.5rem;"></video>` : ''}
                </div>
            `).join('');
        }

        function downloadMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const data = JSON.stringify({ messages, total: messages.length }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `livre-or-${Date.now()}.json`;
            a.click();
        }
    </script>
</body>
</html>
